//! This code was AUTOGENERATED using the codama library.
//! Please DO NOT EDIT THIS FILE, instead use visitors
//! to add features, then rerun codama to update it.
//!
//! <https://github.com/codama-idl/codama>
//!

use borsh::BorshDeserialize;
use borsh::BorshSerialize;
use solana_pubkey::Pubkey;

#[derive(BorshSerialize, BorshDeserialize, Clone, Debug, Eq, PartialEq)]
#[cfg_attr(feature = "serde", derive(serde::Serialize, serde::Deserialize))]
pub struct SwapWithFeesCpiEventEnhanced {
    pub order_id: u64,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub source_mint: Pubkey,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub destination_mint: Pubkey,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub source_token_account_owner: Pubkey,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub destination_token_account_owner: Pubkey,
    pub source_token_change: u64,
    pub destination_token_change: u64,
    pub commission_direction: bool,
    pub commission_rate: u32,
    pub commission_amount: u64,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub commission_account: Pubkey,
    pub platform_fee_rate: u16,
    pub platform_fee_amount: u64,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub platform_fee_account: Pubkey,
    pub trim_rate: u8,
    pub trim_amount: u64,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub trim_account: Pubkey,
    pub charge_rate: u16,
    pub charge_amount: u64,
    #[cfg_attr(
        feature = "serde",
        serde(with = "serde_with::As::<serde_with::DisplayFromStr>")
    )]
    pub charge_account: Pubkey,
}

impl SwapWithFeesCpiEventEnhanced {
    /// CPI log prefix for self CPI events (Anchor standard)
    pub const CPI_LOG_PREFIX: [u8; 8] = [0xe4, 0x45, 0xa5, 0x2e, 0x51, 0xcb, 0x9a, 0x1d];

    /// SwapWithFeesCpiEventEnhanced discriminator bytes (from IDL)
    pub const DISCRIMINATOR: [u8; 8] = [0x25, 0x48, 0xdb, 0x43, 0x32, 0xf4, 0x01, 0xd5];

    /// Parse from inner instruction data with CPI log prefix
    pub fn from_inner_instruction_data(data: &[u8]) -> Option<Self> {
        if !data.starts_with(&Self::CPI_LOG_PREFIX) {
            return None;
        }

        let remaining_data = &data[8..];

        if !remaining_data.starts_with(&Self::DISCRIMINATOR) {
            return None;
        }

        Self::try_from_slice(&remaining_data[8..]).ok()
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use borsh::BorshSerialize;

    #[test]
    fn test_discriminator_constant() {
        assert_eq!(SwapWithFeesCpiEventEnhanced::DISCRIMINATOR, [
            0x25, 0x48, 0xdb, 0x43, 0x32, 0xf4, 0x01, 0xd5
        ]);
    }

    #[test]
    fn test_parse_serialized_event() {
        let mock_event = SwapWithFeesCpiEventEnhanced {
            order_id: 12345,
            source_mint: Pubkey::new_from_array([1u8; 32]),
            destination_mint: Pubkey::new_from_array([2u8; 32]),
            source_token_account_owner: Pubkey::new_from_array([3u8; 32]),
            destination_token_account_owner: Pubkey::new_from_array([4u8; 32]),
            source_token_change: 1000000,
            destination_token_change: 500000,
            commission_direction: false,
            commission_rate: 100,
            commission_amount: 500,
            commission_account: Pubkey::new_from_array([5u8; 32]),
            platform_fee_rate: 10,
            platform_fee_amount: 100,
            platform_fee_account: Pubkey::new_from_array([6u8; 32]),
            trim_rate: 5,
            trim_amount: 50,
            trim_account: Pubkey::new_from_array([7u8; 32]),
            charge_rate: 2,
            charge_amount: 20,
            charge_account: Pubkey::new_from_array([8u8; 32]),
        };

        let mut event_data = Vec::new();
        mock_event.serialize(&mut event_data).expect("Failed to serialize");

        let mut data = Vec::new();
        data.extend_from_slice(&SwapWithFeesCpiEventEnhanced::CPI_LOG_PREFIX);
        data.extend_from_slice(&SwapWithFeesCpiEventEnhanced::DISCRIMINATOR);
        data.extend_from_slice(&event_data);

        let result = SwapWithFeesCpiEventEnhanced::from_inner_instruction_data(&data);
        assert!(result.is_some());

        let parsed_event = result.unwrap();
        assert_eq!(parsed_event.order_id, 12345);
        assert_eq!(parsed_event.source_token_change, 1000000);
        assert_eq!(parsed_event.destination_token_change, 500000);
    }
}
